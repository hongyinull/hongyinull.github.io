<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å¹¸é‹å¤§è½‰ç›¤</title>
  <style>
    @keyframes pulsate {
      0% { transform: scale(1); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    body {
      margin: 0;
      padding: 0;
      font-family: "Helvetica Neue", sans-serif;
      background: url("background.jpg") center/cover no-repeat;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }

    .wheel-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .main-title {
      /* position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none; */
      margin: 0 0 8px;
      /* font-family: 'Times New Roman', serif; */
      font-weight: 900;
      color: #800000;
      -webkit-text-stroke: 2px #800000;
      text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.4);
      font-size: 5em;
      white-space: nowrap;
    }

    .separator {
      width: 80%;
      height: 1px;
      background: rgba(0, 0, 0, 0.5);
      margin: 4px 0 12px;
    }

    canvas {
      width: 100%;
      height: auto;
      aspect-ratio: 1;
      border-radius: 50%;
      /* optional shadow if desired */
    }

    .btn {
      margin-top: 20px;
      padding: 15px 40px;
      font-size: 1.3em;
      background: #e53935;
      color: white;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      transition: 0.2s;
      animation: pulsate 1s infinite;
    }

    .btn:hover {
      background: #d32f2f;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    #result-panel img {
      width: 60%;
      max-width: 220px;
      height: auto;
      margin: 0 auto;
      object-fit: contain;
    }

    #result {
      font-weight: bold;
      text-align: center;
      font-size: 1.2em;
      margin-top: 15px;
    }

    #qrcode {
      display: none;
      max-width: 180px;
      margin: 15px auto 0;
    }

    .card {
      background: rgba(255, 255, 255, 0.01);
      border-radius: 20px;
      max-width: 900px;
      width: 100%;
      padding: 30px;
      /* box-shadow removed */
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .main-content {
      display: flex;
      width: 100%;
      gap: 40px;
      align-items: stretch;
    }

    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      height: 100%;
    }

    .right-panel > * {
      width: 100%;
    }

    .prize-list {
      background: #ffecec;
      border-radius: 10px;
      padding: 10px 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .prize-list h2 {
      margin-top: 0;
      color: #d14343;
    }

    .prize-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .prize-list li {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 1em;
    }

    #result-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      justify-content: center;
      flex: 0;
      align-self: stretch;
    }

    .result-message {
      font-size: 1.1em;
      color: #b03030;
      margin: 10px 0 0;
      min-height: 1.5em;
    }

    .instructions {
      background: #fffbea;
      border-radius: 10px;
      padding: 20px;
    }

    .remote-status {
      margin-top: 10px;
      font-size: 0.9em;
      color: #4e3629;
      text-align: center;
    }

    .instructions h2 {
      margin-top: 0;
      color: #d17000;
    }

    .button-wrapper {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    #resultQrcode {
      display: none;
    }

    #keyOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: clamp(5rem, 25vw, 20rem);
      font-weight: 900;
      color: #fff;
      text-shadow:
        0 0 30px rgba(255, 0, 0, 0.75),
        0 0 60px rgba(255, 0, 0, 0.45),
        0 10px 30px rgba(0, 0, 0, 0.6);
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s ease;
      z-index: 999;
    }

    #keyOverlay.visible {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="main-content">
      <div class="wheel-container">
        <h1 class="main-title">å…è²»æŠ½å¤§ç</h1>
        <div class="separator"></div>
        <canvas id="wheel"></canvas>
        <div class="button-wrapper">
          <button id="spinBtn" class="btn" onclick="spinWheel()">é»é¸å¹¸é‹æ•¸å­—</button>
        </div>
      </div>
      <div class="right-panel">
        <div class="instructions">
          <!-- <h1>å¦‚ä½•æŠ½ç</h1> -->
          <h1>é”æˆæŒ‡å®šæ¢ä»¶å°±å¯ä»¥å…è²»æŠ½çï¼</h1>
          <h1>----------------------------------------------------------------------------------------------</h1>
          <h1>ç•™è¨€ï¼šç‹¸å°è·¯ç‡’è‚‰è®š</h1>
        </div>
        <div class="prize-list" id="result-panel">
          <img id="joinQrcode" src="join.png" alt="åŠ å…¥æŠ½ç QRCode">
          <img id="resultQrcode" src="" alt="çå“ QR Code">
          <p id="resultMessage" class="result-message"></p>
          <p id="remoteStatus" class="remote-status">é ç«¯é€£ç·šæº–å‚™ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <div id="keyOverlay"></div>

  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    // Idle rotation settings
    let isSpinning = false;
    const idleSpeed = 0.002; // radians per frame


    const prizes = [
      { name: "å¥åº·æœé†‹é£²", area: 28, chance: 48, qrcode: "join.png" },
      { name: "è¿·ä½ æ‰‹å·¥çš‚", area: 16, chance: 10, qrcode: "soap.png" },
      { name: "æµ·è€ç‚¸è¦ç å¯¶ç›’ å…Œæ›åˆ¸", area: 8, chance: 5, qrcode: "join.png" },
      { name: "ç‹¸å°è·¯å¾¡å®ˆ", area: 7, chance: 0, qrcode: "join.png" },
      { name: "èœœæ¡ƒæ°£æ³¡æ²™ç“¦", area: 11, chance: 15, qrcode: "join.png" },
      { name: "èŠéº»å¿ƒå¤ªè»Ÿå…Œæ›åˆ¸", area: 14, chance: 15, qrcode: "join.png" },
      { name: "ç¾å ´æ¶ˆè²»88æŠ˜ï¼", area: 8, chance: 3, qrcode: "discount15.png" },
      { name: "ç¾å ´æ¶ˆè²»9æŠ˜ï¼", area: 8, chance: 4, qrcode: "discount10.png" }
    ];

    // Color palette for wheel slices (earthy, harmonious)
    const sliceColors = [
      "#5C4033", // dark brown
      "#8B4513", // saddle brown
      "#CD853F", // peru
      "#D2B48C", // tan
      "#A0522D", // sienna
      "#F4A460", // sandy brown
      "#800000", // maroon
      "#8B7355", // dark khaki
      "#DAA520", // goldenrod
      "#B8860B"  // dark goldenrod
    ];

    const canvas = document.getElementById("wheel");
    const ctx = canvas.getContext("2d");
    // High DPI & responsive canvas
    function setupCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.scale(dpr, dpr);
    }
    setupCanvas();
    window.addEventListener('resize', () => {
      setupCanvas();
      drawWheel(currentRotation || 0);
    });
    let currentRotation = 0;
    let angleMap = [];

    function drawWheel(rotation = 0) {
      const rect = canvas.getBoundingClientRect();
      const size = rect.width;
      const center = size / 2;
      const radius = center;
      ctx.clearRect(0, 0, size, size);
      let totalArea = prizes.reduce((sum, p) => sum + p.area, 0);
      let startAngle = 0;
      angleMap = [];

      prizes.forEach((p, i) => {
        const arc = (p.area / totalArea) * 2 * Math.PI;
        ctx.beginPath();
        ctx.moveTo(center, center);
        ctx.fillStyle = sliceColors[i % sliceColors.length];
        ctx.arc(center, center, radius, startAngle + rotation, startAngle + arc + rotation);
        ctx.fill();

        const angle = startAngle + arc / 2 + rotation;
        const textRadius = radius * 0.75;
        const textX = center + Math.cos(angle) * textRadius;
        const textY = center + Math.sin(angle) * textRadius;
        ctx.save();
        ctx.translate(textX, textY);
        ctx.rotate(angle);
        ctx.textAlign = "center";
        ctx.fillStyle = "#ffffff";
        ctx.font = "bold 24px sans-serif";
        ctx.fillText(p.name, 0, 0);
        ctx.restore();

        angleMap.push({ start: startAngle, end: startAngle + arc, prize: p });
        startAngle += arc;
      });

      ctx.beginPath();
      ctx.arc(center, center, 30, 0, 2 * Math.PI);
      ctx.fillStyle = "#fff";
      ctx.fill();
      ctx.strokeStyle = "#ccc";
      ctx.stroke();

      // Draw pointer as part of canvas within wheel
      ctx.save();
      ctx.fillStyle = '#e53935';
      // Add drop shadow
      ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
      ctx.shadowBlur = 10;
      const pointerLength = 40;
      const pointerWidth = 28;
      const bx = center + radius - pointerLength;
      const by = center;
      ctx.beginPath();
      ctx.moveTo(bx, by - pointerWidth);
      ctx.lineTo(bx + pointerLength, by);
      ctx.lineTo(bx, by + pointerWidth);
      ctx.closePath();
      ctx.fill();
      // Draw white border
      ctx.lineWidth = 4;
      ctx.strokeStyle = '#ffffff';
      ctx.stroke();
      ctx.restore();

      currentRotation = rotation;
    }

    function spinWheel() {
      isSpinning = true;

      const rand = Math.random() * 100;
      let sum = 0, selected = null;
      for (let p of prizes) {
        sum += p.chance;
        if (rand <= sum) {
          selected = p;
          break;
        }
      }

      let totalArea = prizes.reduce((sum, p) => sum + p.area, 0);
      let selectedAngleInfo = angleMap.find(a => a.prize.name === selected.name);
      let sliceAngle = (selected.area / totalArea) * 2 * Math.PI;

      const finalAngle = - (selectedAngleInfo.start + sliceAngle / 2);
      const totalRotation = (2 * Math.PI * 5) + finalAngle;

      const duration = 4000;
      const start = performance.now();

      function animate(now) {
        const t = (now - start) / duration;
        if (t < 1) {
          const eased = t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
          const a = eased * totalRotation;
          drawWheel(a);
          requestAnimationFrame(animate);
        } else {
          showResult(selected);
        }
      }

      requestAnimationFrame(animate);
    }

    function showResult(prize) {
      const joinImg = document.getElementById("joinQrcode");
      const resultImg = document.getElementById("resultQrcode");
      const resultMessage = document.getElementById("resultMessage");
      const spinBtn = document.getElementById('spinBtn');
      resultMessage.textContent = `ğŸ‰ æ­å–œä½ æŠ½ä¸­ï¼š${prize.name}`;
      joinImg.style.display = "none";
      resultImg.src = prize.qrcode;
      resultImg.style.display = "block";
      // Disable further spins during countdown
      spinBtn.disabled = true;
      // Countdown on button
      let countdown = 4;
      spinBtn.textContent = countdown;
      const intervalId = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          spinBtn.textContent = countdown;
        } else {
          clearInterval(intervalId);
        }
      }, 1000);
      setTimeout(() => {
        joinImg.style.display = "block";
        resultImg.style.display = "none";
        resultMessage.textContent = "";
        spinBtn.textContent = 'é»é¸å¹¸é‹æ•¸å­—';
        spinBtn.disabled = false;
        isSpinning = false;
      }, 4000);
      launchConfetti();
    }

    drawWheel();

    // Button click listener
    const spinBtn = document.getElementById('spinBtn');
    spinBtn.addEventListener('click', () => {
      if (!isSpinning) spinWheel();
    });

    // Idle animation loop
    function idleAnimate() {
      if (!isSpinning) {
        currentRotation += idleSpeed;
        drawWheel(currentRotation);
      }
      requestAnimationFrame(idleAnimate);
    }
    idleAnimate();

    const keyOverlay = document.getElementById('keyOverlay');
    let overlayTimeout;

    function showKeyOverlay(label) {
      if (!label) return;
      keyOverlay.textContent = `${label}!!`;
      keyOverlay.classList.add('visible');
      clearTimeout(overlayTimeout);
      overlayTimeout = setTimeout(() => {
        keyOverlay.classList.remove('visible');
      }, 900);
    }

    function formatKeyDisplay(key) {
      if (!key) return "";
      const aliases = {
        ' ': 'SPACE',
        'Enter': 'ENTER',
        'Backspace': 'âŒ«',
        'Shift': 'SHIFT',
        'Control': 'CTRL',
        'Alt': 'ALT',
        'Meta': 'âŒ˜'
      };
      if (aliases[key] !== undefined) return aliases[key];
      if (key.startsWith('Arrow')) {
        return `ç®­é ­ ${key.slice(5).toUpperCase()}`;
      }
      if (key.length === 1) {
        return key.toUpperCase();
      }
      return key.toUpperCase();
    }

    function launchConfetti() {
      if (typeof confetti !== 'function') return;
      const bursts = 8;
      for (let i = 0; i < bursts; i++) {
        setTimeout(() => {
          confetti({
            particleCount: 160,
            spread: 88,
            startVelocity: 55,
            scalar: 1.4,
            gravity: 0.7,
            ticks: 250,
            origin: {
              x: 0.2 + Math.random() * 0.6,
              y: Math.random() * 0.2
            }
          });
        }, i * 120);
      }
      setTimeout(() => {
        confetti({
          particleCount: 240,
          spread: 120,
          startVelocity: 65,
          scalar: 1.6,
          gravity: 0.65,
          origin: { x: 0.5, y: 0 }
        });
      }, bursts * 120);
    }

    // Start spin on any key press & show overlay
    window.addEventListener('keydown', (event) => {
      const displayKey = formatKeyDisplay(event.key || "");
      if (displayKey) {
        showKeyOverlay(displayKey);
      }
      if (!isSpinning) spinWheel();
    });

    // Remote trigger via PeerJS (remote page can connect with matching peerId)
    const peerId = new URLSearchParams(window.location.search).get('peer') || 'draw-wheel-host';
    const remoteStatus = document.getElementById('remoteStatus');
    const peer = new Peer(peerId, {
      host: '0.peerjs.com',
      port: 443,
      path: '/'
    });
    peer.on('open', () => {
      remoteStatus.textContent = `é ç«¯é€£ç·š IDï¼š${peerId}`;
    });
    peer.on('connection', (conn) => {
      remoteStatus.textContent = "é ç«¯å·²é€£ç·šï¼Œå¯é€éæ‰‹æ©Ÿæ§åˆ¶æŠ½ç";
      conn.on('data', (data) => {
        if (data === 'spin' && !isSpinning) {
          spinWheel();
        }
      });
      conn.on('close', () => {
        remoteStatus.textContent = "é ç«¯å·²æ–·ç·šï¼Œç­‰å¾…å†æ¬¡é€£ç·š...";
      });
    });
    peer.on('error', (err) => {
      console.error(err);
      remoteStatus.textContent = `é ç«¯é€£ç·šéŒ¯èª¤ï¼š${err.type || err}`;
    });
  </script>
</body>
</html>
